//prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // bcrypt hashed
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  settings         UserSettings?
  gardens          Garden[]
  beds             Bed[]
  plants           Plant[]
  seedInventory    SeedInventory[]
  journalEntries   GardenJournal[]
  gardenYears      GardenYear[]
  frostDateHistory FrostDateHistory[]

  // NextAuth.js session support
  accounts           Account[]
  sessions           Session[]
  passwordResetTokens PasswordResetToken[]

  @@index([email])
}

// NextAuth.js models (required by PrismaAdapter)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Password reset tokens
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique // hashed token
  expires   DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// User settings - now per-user instead of singleton
model UserSettings {
  id        Int      @id @default(autoincrement())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lastSpringFrost DateTime
  firstFallFrost  DateTime
  zone            String?
  zip             String?  // User's ZIP code for frost lookups
  units           String   @default("imperial") // "imperial" or "metric"

  // Actual frost dates for tracking real conditions (user-recorded)
  actualLastSpringFrost DateTime? // When frost actually last occurred in spring
  actualFirstFallFrost  DateTime? // When frost actually first occurred in fall

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Historical frost date records - stores actual frost dates by year
model FrostDateHistory {
  id        Int      @id @default(autoincrement())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  year                  Int       // The year this record is for (e.g., 2025, 2026)
  actualLastSpringFrost DateTime? // When frost actually last occurred in spring
  actualFirstFallFrost  DateTime? // When frost actually first occurred in fall
  notes                 String?   // Optional notes about the frost conditions

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@index([userId])
  @@index([userId, year])
}

// Plant model - now per-user
model Plant {
  id        Int      @id @default(autoincrement())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name          String
  variety       String?
  verdantlyId   String?  // External ID from Verdantly API for reliable backfill lookups
  spacingInches Float   @default(12)

  daysToMaturityMin Int?
  daysToMaturityMax Int?

  startIndoorsWeeksBeforeFrost  Int?
  transplantWeeksAfterFrost     Int?
  directSowWeeksRelativeToFrost Int?

  // Full text planting instructions from Verdantly
  startIndoorsInstructions String? // e.g., "Yes, 3-4 weeks before the last frost."
  transplantInstructions   String? // e.g., "After last frost when soil temp reaches 50Â°F."
  directSowInstructions    String? // e.g., "Yes, directly sow once frost has passed."

  plantingDepthInches Float?

  notes String?

  // Seed tracking
  hasSeeds Boolean @default(false) // User has seeds for this plant

  // Additional Trefle data fields
  scientificName   String? // Scientific/botanical name
  growthForm       String? // e.g., "herb", "shrub", "tree"
  growthHabit      String? // e.g., "erect", "spreading"
  growthRate       String? // e.g., "slow", "moderate", "fast"
  averageHeightInches Float? // Average mature height in inches
  minTemperatureC  Float?  // Minimum temperature requirement (Celsius)
  maxTemperatureC  Float?  // Maximum temperature requirement (Celsius)
  lightRequirement Int?    // Light requirement (0-10 scale)
  soilNutriments   Int?    // Soil nutrient requirements (0-10 scale)
  soilHumidity     Int?    // Soil humidity requirements (0-10 scale)
  edible           Boolean @default(false) // Is the plant edible
  ediblePart       String? // Edible parts (comma-separated)

  // Growing condition fields
  cycle              String? // "Annual", "Perennial", "Biennial"
  watering           String? // Watering frequency (e.g., "Frequent", "Average")
  sunlight           String? // Sunlight requirements (comma-separated)
  floweringSeason    String? // When the plant flowers
  harvestSeason      String? // When to harvest (important for vegetables)
  careLevel          String? // "Easy", "Medium", "Hard"
  maintenance        String? // Maintenance requirements
  indoor             Boolean @default(false) // Can be grown indoors
  droughtTolerant    Boolean @default(false) // Drought tolerant
  medicinal          Boolean @default(false) // Has medicinal properties
  poisonousToHumans  Int?    // 0 = not poisonous, 1 = poisonous
  poisonousToPets    Int?    // 0 = not poisonous, 1 = poisonous
  description        String? // Full plant description

  // Pollinator tracking
  attractsPollinators Boolean @default(false) // Attracts bees, butterflies, etc.
  pollinatorTypes     String? // Comma-separated: "bees,butterflies,hummingbirds"

  // Water zone classification
  waterZone           String? // "low", "medium", "high" water needs

  // Sunlight zone classification
  sunlightZone        String? // "full", "partial", "shade" for micro climate matching

  // Succession planting configuration
  successionEnabled      Boolean @default(false) // Enable succession planting for this plant
  successionIntervalDays Int?    // Days between plantings (e.g., 14 for lettuce)
  successionMaxCount     Int?    // Max number of successions to suggest (e.g., 6)

  placements    BedPlacement[]
  seedInventory SeedInventory[]
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, name])
  @@index([verdantlyId])
}

// Bed model - now per-user
model Bed {
  id        Int      @id @default(autoincrement())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name         String
  widthInches  Int
  heightInches Int
  cellInches   Int     @default(12) // grid size: 6 or 12 are common
  notes        String? // user notes about this bed (e.g., "North side, afternoon shade")
  gardenX      Int? // top-left position in garden grid cells
  gardenY      Int? // top-left position in garden grid cells
  gardenRotated Boolean @default(false)

  // Micro-climate conditions (comma-separated for multiple: "partial-shade,windy")
  // Options: full-sun, partial-shade, full-shade, south-facing, north-facing, windy, sheltered, wet, dry
  microClimate String?

  placements        BedPlacement[]
  placementHistory  PlacementHistory[]
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Garden model - now per-user, removed hardcoded id=1
model Garden {
  id           Int      @id @default(autoincrement())
  userId       String   @unique // one garden per user
  widthInches  Int
  heightInches Int
  cellInches   Int      @default(12)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  walkways  Walkway[]
  gates     Gate[]

  @@index([userId])
}

// Walkway - paths/aisles in the garden
model Walkway {
  id        Int      @id @default(autoincrement())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  x      Int // position in garden grid cells
  y      Int
  width  Int // size in garden grid cells
  height Int
  name   String? // optional label

  garden Garden @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
}

// Gate - entry/exit points in the garden
model Gate {
  id        Int      @id @default(autoincrement())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  x      Int    // position in garden grid cells
  y      Int
  side   String // 'top', 'right', 'bottom', 'left'
  width  Int    @default(1) // width of gate opening in cells
  name   String? // optional label

  garden Garden @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
}

// SeedInventory - tracks seed packets and their quantities
model SeedInventory {
  id        Int      @id @default(autoincrement())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plantId     Int?    // optional link to a plant in the user's library
  name        String  // seed name (may differ from plant name for varieties)
  variety     String? // specific variety
  brand       String? // seed company/brand
  quantity    Int     @default(1) // number of seed packets
  seedCount   Int?    // approximate number of seeds per packet
  purchaseDate DateTime? // when purchased
  expirationDate DateTime? // seed viability date
  lotNumber   String? // lot number for tracking
  notes       String? // user notes

  // Planting info
  sowingInstructions String? // instructions from packet
  daysToGermination  Int?    // days until germination
  germinationRate    Float?  // percentage (0-100)

  // Status tracking
  status      String @default("available") // "available", "low", "empty", "expired"

  plant Plant? @relation(fields: [plantId], references: [id], onDelete: SetNull)
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
}

// BedPlacement - tracks plant placements in beds with lifecycle information
model BedPlacement {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bedId   Int
  plantId Int

  // Position in inches from top-left (0-based, 1-inch precision)
  x Float
  y Float
  w Float @default(1) // width/footprint in inches
  h Float @default(1) // height/footprint in inches

  count Int @default(1)

  // Spring planting tracking
  seedsStartedDate        DateTime? // when seeds were started indoors
  transplantedDate        DateTime? // when transplanted outdoors
  directSowedDate         DateTime? // when direct sowed
  notes                   String?   // user notes about this placement

  // Harvest tracking
  harvestStartedDate      DateTime? // when harvesting actually started
  harvestEndedDate        DateTime? // when harvesting finished
  harvestYield            Float?    // total harvest amount
  harvestYieldUnit        String?   // unit: "lbs", "oz", "count", "bunches", etc.

  // Succession planting tracking
  successionGroupId       String?   // UUID to link related plantings in a succession series
  successionNumber        Int?      // 1, 2, 3... for ordering within the group
  expectedHarvestDate     DateTime? // Calculated from planting date + days-to-maturity

  bed   Bed   @relation(fields: [bedId], references: [id], onDelete: Cascade)
  plant Plant @relation(fields: [plantId], references: [id], onDelete: Cascade)

  @@unique([bedId, x, y]) // prevents two placements from sharing the exact same cell
  @@index([bedId])
  @@index([plantId])
  @@index([successionGroupId])
}

// PlacementHistory - archived placements for crop rotation tracking
model PlacementHistory {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  bedId      Int
  plantName  String  // Store plant name directly (in case plant is deleted)
  plantType  String? // Store plant type/family for rotation warnings (e.g., "nightshade", "brassica")

  // Position in inches (same coordinate system as BedPlacement)
  x Float
  y Float
  w Float @default(12)
  h Float @default(12)

  // Season tracking
  seasonYear   Int     // e.g., 2025
  seasonName   String  // "spring", "summer", "fall", "winter"

  // Harvest summary
  harvestYield     Float?
  harvestYieldUnit String?
  notes            String?

  bed Bed @relation(fields: [bedId], references: [id], onDelete: Cascade)

  @@index([bedId, seasonYear])
  @@index([bedId, x, y])
}

// GardenJournal - journal entries with photos for tracking garden progress
model GardenJournal {
  id        Int      @id @default(autoincrement())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entryDate   DateTime @default(now()) // Date of the journal entry
  title       String?  // Optional title
  content     String   // Journal entry text (markdown supported)
  weatherNote String?  // Weather conditions that day
  temperature Float?   // Temperature recorded

  // Optional associations
  bedId       Int?     // Link to a specific bed
  placementId Int?     // Link to a specific plant placement

  // Photos (stored as comma-separated URLs or base64)
  photos      String?  // JSON array of photo URLs/paths

  // Tags for filtering
  tags        String?  // Comma-separated: "harvest,pest,milestone"

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, entryDate])
  @@index([userId, bedId])
}

// GardenYear - for garden inheritance/copying between years
model GardenYear {
  id        Int      @id @default(autoincrement())
  userId    String
  createdAt DateTime @default(now())

  year        Int     // e.g., 2025, 2026
  name        String? // Optional name like "2025 Spring Garden"

  // Snapshot of garden configuration (JSON)
  gardenSnapshot String? // JSON blob of garden layout
  bedsSnapshot   String? // JSON blob of beds and placements

  // Stats summary
  totalBeds       Int @default(0)
  totalPlacements Int @default(0)
  totalHarvest    Float?
  harvestUnit     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@index([userId])
}
